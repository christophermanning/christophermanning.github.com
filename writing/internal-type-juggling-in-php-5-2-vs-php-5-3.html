<!DOCTYPE html>
<html>
<head>
<base href="https://www.christophermanning.org" />
<title>Internal Type Juggling in PHP 5.2 vs PHP 5.3 - Christopher Manning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<meta name="Description" content="Christopher Manning lives in Chicago, Illinois where he works as a software engineer.">


	<meta property="og:type" content="article" />
	<meta property="og:title" content="Internal Type Juggling in PHP 5.2 vs PHP 5.3" />


	<meta property="og:url" content="https://www.christophermanning.org/writing/internal-type-juggling-in-php-5-2-vs-php-5-3/" />


	<meta property="og:site_name" content="Christopher Manning" />


	<meta property="article:published_time" content="2011-09-20T00:00:00+00:00" />

<link rel="alternate" type="application/rss+xml" title="Christopher Manning" href="https://www.christophermanning.org/feed.xml">
<link href="/css/main.css" rel="stylesheet" media="screen">
<link rel="shortcut icon" href="https://www.christophermanning.org/favicon.ico?v=2">
</head>
<script>
window.onload = () => {
  document.querySelectorAll('[data-toggle]')[0].addEventListener('click', () => {
    document.querySelectorAll('.navbar-collapse')[0].classList.toggle('collapse');
  });
}
</script>
<body>
<div class="navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.christophermanning.org/">Christopher Manning</a>
    </div>
    <div class="navbar-collapse collapse navbar-responsive-collapse">
      <ul class="nav navbar-nav">
        
        
          
            <li >
              <a href="/about" title="">About</a>
            </li>
          
        
          
            <li >
              <a href="/projects" title="">Projects</a>
            </li>
          
        
          
            <li class="active">
              <a href="/writing" title="">Writing</a>
            </li>
          
        
      </ul>
    </div>
  </div>
</div>
<div class="container">
  <h1>Internal Type Juggling in PHP 5.2 vs PHP 5.3</h1>

<div><p>
There is an undocumented case where the output of an internal function is different in PHP 5.2 vs PHP 5.3 when you pass it an invalid argument.

<!--more-->

<p>
For example, strlen returns different values and warnings/notices when attempting to pass it an array.

<h4>PHP 5.2</h4>
<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="o">&gt;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="k">array</span><span class="p">()));</span>
<span class="no">PHP</span> <span class="nc">Notice</span><span class="o">:</span>  <span class="k">Array</span> <span class="n">to</span> <span class="n">string</span> <span class="n">conversion</span> <span class="n">in</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">1</span>

<span class="nc">Notice</span><span class="o">:</span> <span class="k">Array</span> <span class="n">to</span> <span class="n">string</span> <span class="n">conversion</span> <span class="n">in</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">1</span>
<span class="nf">int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></figure>
<h4>PHP 5.3</h4>
<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="o">&gt;</span> <span class="nb">var_dump</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="k">array</span><span class="p">()));</span>
<span class="no">PHP</span> <span class="nc">Warning</span><span class="o">:</span>  <span class="nb">strlen</span><span class="p">()</span> <span class="n">expects</span> <span class="n">parameter</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">be</span> <span class="n">string</span><span class="p">,</span> <span class="k">array</span> <span class="n">given</span> <span class="n">in</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">1</span>
<span class="no">PHP</span> <span class="nc">Stack</span> <span class="n">trace</span><span class="o">:</span>
<span class="no">PHP</span>   <span class="mf">1.</span> <span class="p">{</span><span class="n">main</span><span class="p">}()</span> <span class="n">php</span> <span class="n">shell</span> <span class="n">code</span><span class="o">:</span><span class="mi">0</span>
<span class="no">PHP</span>   <span class="mf">2.</span> <span class="nb">strlen</span><span class="p">()</span> <span class="n">php</span> <span class="n">shell</span> <span class="n">code</span><span class="o">:</span><span class="mi">1</span>

<span class="nc">Warning</span><span class="o">:</span> <span class="nb">strlen</span><span class="p">()</span> <span class="n">expects</span> <span class="n">parameter</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">be</span> <span class="n">string</span><span class="p">,</span> <span class="k">array</span> <span class="n">given</span> <span class="n">in</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">1</span>

<span class="nc">Call</span> <span class="nc">Stack</span><span class="o">:</span>
  <span class="mf">467.9296</span>     <span class="mi">320928</span>   <span class="mf">1.</span> <span class="p">{</span><span class="n">main</span><span class="p">}()</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span><span class="o">:</span><span class="mi">0</span>
  <span class="mf">467.9296</span>     <span class="mi">321072</span>   <span class="mf">2.</span> <span class="nb">strlen</span><span class="p">()</span> <span class="n">php</span>  <span class="n">shell</span> <span class="n">code</span><span class="o">:</span><span class="mi">1</span>

<span class="kc">NULL</span></code></pre></figure>
<p>
The E_WARNING and return value of NULL in PHP 5.3 is preferred, but I still wanted to know why PHP 5.2 was returning int(5). 
I tracked down the reason to <a rel="external" href="http://svn.php.net/viewvc?view=revision&revision=261338">this subversion commit</a> and <a rel="external" href="http://svn.php.net/viewvc/php/php-src/branches/PHP_5_3/Zend/zend_builtin_functions.c?r1=261338&r2=261337&pathrev=261338">this patch</a>.

<p>
<script src="https://gist.github.com/christophermanning/1234032.js?file=PHP%205.3%20strlen.patch"></script>

<p>
In the above patch, I see that strlen and other functions(method_exists, property_exists, function_exists, strcmp, strncmp, strcasecmp, strncasecmp, defined, is_a_impl) were not using zend_parse_parameters to get the arguments. 
This was preventing the standard validations and warnings from running for that function. Also, those functions were incorrectly casting the arguments to string with convert_to_string_ex. 
That is why, in PHP 5.2, strlen() of array() is int(5); because, <a rel="external" href="http://www.php.net/manual/en/language.types.string.php#language.types.string.casting">casting array() to string returns "Array"</a>.

<p>
Now, in PHP 5.3, those functions will no longer coerce the arguments to strings, will return NULL, and will issue a warning when invalid arguments have been provided. Thanks <a href="http://php100.wordpress.com/" rel="external">stas</a>.

</div>

<div class="clearfix">&nbsp;</div>

<hr>

<small>September 20, 2011</small>

  <div class="clearfix">&nbsp;</div>
  <footer style="margin: 5em 0;">
    <div class="row">
      <div>
        <ul class="list-unstyled">
          <li class="pull-right"><a href="#top">Back to top</a></li>
        </ul>
      </div>
    </div>
  </footer>
</div>
</body>
</html>
